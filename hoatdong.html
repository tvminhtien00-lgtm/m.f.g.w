<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoạt Động Nhóm - LỬA MIỄN PHÍ</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: auto; }
        
        /* Menu điều hướng */
        nav { text-align: center; margin-bottom: 10px; }
        nav a { text-decoration: none; color: #1877f2; font-weight: bold; margin: 0 10px; }

        /* Phần khai báo tên */
        .identity-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Card ảnh */
        .photo-card { background: white; margin-bottom: 30px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .photo-grid { display: flex; flex-wrap: wrap; gap: 5px; }
        .photo-grid img { width: calc(50% - 5px); height: 250px; object-fit: cover; cursor: pointer; transition: 0.2s; }
        .photo-grid img:hover { transform: scale(1.02); }

        /* Phần bình luận */
        .comment-section { padding: 15px; border-top: 1px solid #eee; }
        .comment-list { max-height: 300px; overflow-y: auto; margin-bottom: 10px; }
        .comment-item { font-size: 14px; background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .btn-delete { border: none; background: #ff4d4d; color: white; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; height: fit-content; }
        
        .comment-input-area { display: flex; gap: 10px; }
        .comment-input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        .btn-comment { background: #1877f2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .loading-text { text-align: center; color: gray; font-style: italic; }
    </style>
</head>


<body>

    <nav>
        <a href="index.html">Trang Chủ</a> | 
        <a href="tvlop.html">Thành Viên Nhóm</a>
    </nav>

    <div class="container identity-box">
        <label style="font-weight: bold;">Danh tính: </label>
        <input type="text" id="user-name-input" placeholder="Nhập tên của bạn..." 
               onchange="saveUsername(this.value)" 
               style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 200px;">
    </div>

    <div class="container" id="gallery">
        <p class="loading-text">Đang kết nối dữ liệu...</p>
    </div>


<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwI66pmvlV3qp3QKIvbTHNQ74zaQhUSJICH2OVKLoCT2b8kWRjfQBH6uROC9RzHCtPahw/exec';
    
    // 1. Quản lý danh tính người dùng
    let currentUserName = localStorage.getItem('myUserName') || "Người lạ";
    document.getElementById('user-name-input').value = currentUserName === "Người lạ" ? "" : currentUserName;

    function saveUsername(name) {
        if(name.trim() === "") return;
        localStorage.setItem('myUserName', name);
        currentUserName = name;
        alert("Chào " + name + "!");
        loadCommentsFromCloud(); 
    }  

    if (!localStorage.getItem('myUserId')) {
        localStorage.setItem('myUserId', 'user_' + Math.random().toString(36).substr(2, 9));
    }
    const currentUserId = localStorage.getItem('myUserId');

    // 2. Danh sách bài đăng (Ảnh)
    const photos = [
        { 
            id: "img2", 
            src: ["img/HANVOIU.png","img/HANCAN5.png"], 
            caption: "Trùm bom keo" 
        },
        { 
            id: "img3", 
            src: ["img/QUANDOANFF.png"], 
            caption: "Kỷ niệm ngày thành lập" 
        }
    ];

    // 3. Lấy dữ liệu từ Cloud
    async function loadCommentsFromCloud() {
        try {
            const response = await fetch(`${scriptURL}?action=read`);
            const allComments = await response.json();
            renderGallery(allComments);
        } catch (error) {
            console.error("Lỗi kết nối:", error);
            renderGallery({}); 
        }
    }

    // 4. Hiển thị giao diện
    function renderGallery(allComments) {
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";

        photos.forEach(photo => {
            const photoComments = allComments[photo.id] || [];
            const card = document.createElement('div');
            card.className = 'photo-card';
            
            card.innerHTML = `
                <div class="photo-grid">
                    ${photo.src.map(imgSrc => `<img src="${imgSrc}">`).join('')}
                </div>
                <div style="padding: 10px; font-weight: bold;">${photo.caption}</div>
                <div class="comment-section">
                    <div class="comment-list">
                        ${photoComments.map((c, index) => `
                            <div class="comment-item">
                                <span><b>${c.userName || 'Người lạ'}:</b> ${c.content}</span>
                                ${c.ownerId === currentUserId ? 
                                    `<button class="btn-delete" onclick="deleteComment('${photo.id}', ${index})">Xóa</button>` : ''}
                            </div>
                        `).reverse().join('')}
                    </div>
                    <div class="comment-input-area">
                        <input type="text" id="input-${photo.id}" placeholder="Viết bình luận...">
                        <button class="btn-comment" onclick="addCommentToCloud('${photo.id}')">Gửi</button>
                    </div>
                </div>
            `;
            gallery.appendChild(card);
        });
    }

    // 5. Gửi bình luận
    window.addCommentToCloud = function(photoId) {
        const input = document.getElementById(`input-${photoId}`);
        const text = input.value.trim();
        if (!text) return;

        input.disabled = true;
        const finalURL = `${scriptURL}?action=write&photoId=${photoId}&content=${encodeURIComponent(text)}&ownerId=${currentUserId}&userName=${encodeURIComponent(currentUserName)}`;

        fetch(finalURL)
        .then(() => {
            input.value = "";
            input.disabled = false;
            loadCommentsFromCloud();
        })
        .catch(() => {
            alert("Lỗi mạng, thử lại nhé!");
            input.disabled = false;
        });
    }

    window.deleteComment = function(photoId, index) {
        alert("Tính năng xóa đang bảo trì trên hệ thống Cloud.");
    }

    loadCommentsFromCloud();
    
</script>
</body>
</html>